<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AMIS OCR System</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #667eea;
        --secondary: #764ba2;
        --success: #10b981;
        --danger: #ef4444;
        --dark: #1f2937;
        --light: #f9fafb;
        --border: #e5e7eb;
      }

      body {
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          "Segoe UI",
          sans-serif;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--secondary) 100%
        );
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
        animation: fadeIn 0.6s;
      }

      h1 {
        font-size: 3.5rem;
        margin-bottom: 15px;
        text-shadow: 2px 4px 12px rgba(0, 0, 0, 0.3);
        font-weight: 700;
        letter-spacing: -0.5px;
      }

      header p {
        font-size: 1.15rem;
        opacity: 0.95;
        text-shadow: 1px 2px 4px rgba(0, 0, 0, 0.2);
        font-weight: 500;
      }

      .card {
        background: white;
        border-radius: 24px;
        padding: 45px;
        box-shadow: 0 25px 70px rgba(0, 0, 0, 0.35);
        animation: slideUp 0.6s;
        backdrop-filter: blur(10px);
        position: relative;
      }

      .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, var(--primary), var(--secondary), var(--primary));
        border-radius: 24px 24px 0 0;
        background-size: 200% 100%;
        animation: gradientShift 3s ease infinite;
      }

      @keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 35px;
        border-bottom: 2px solid var(--border);
        padding-bottom: 0;
      }

      .tab {
        padding: 16px 35px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 1.05rem;
        font-weight: 600;
        color: #6b7280;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        margin: 0;
        border-radius: 12px 12px 0 0;
      }

      .tab::before {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        transform: scaleX(0);
        transition: transform 0.3s;
      }

      .tab:hover {
        color: var(--primary);
        background: rgba(102, 126, 234, 0.05);
      }

      .tab.active {
        color: var(--primary);
        background: rgba(102, 126, 234, 0.08);
      }

      .tab.active::before {
        transform: scaleX(1);
      }

      .tab-content {
        display: none;
        animation: fadeIn 0.4s;
      }

      .tab-content.active {
        display: block;
      }

      /* Upload Area */
      .upload-area {
        border: 3px dashed var(--primary);
        border-radius: 20px;
        padding: 60px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.05));
        position: relative;
        overflow: hidden;
      }

      .upload-area::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
      }

      .upload-area:hover::before {
        left: 100%;
      }

      .upload-area:hover {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.1));
        transform: translateY(-3px);
        box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
        border-color: var(--secondary);
      }

      .upload-area.dragover {
        border-color: var(--success);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 5rem;
        margin-bottom: 20px;
        animation: float 3s ease-in-out infinite;
      }

      @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
      }

      #fileInput {
        display: none;
      }

      /* Image Preview */
      .image-preview {
        display: none;
        margin-top: 25px;
        text-align: center;
        animation: fadeIn 0.5s;
      }

      .image-preview.show {
        display: block;
      }

      .preview-container {
        position: relative;
        display: inline-block;
        max-width: 100%;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        background: white;
        padding: 15px;
      }

      .preview-container img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 10px;
        display: block;
      }

      .preview-info {
        margin-top: 15px;
        padding: 12px 20px;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 10px;
        display: inline-block;
        font-size: 0.95rem;
        color: #495057;
        font-weight: 500;
      }

      .remove-image {
        position: absolute;
        top: 25px;
        right: 25px;
        background: rgba(239, 68, 68, 0.95);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
      }

      .remove-image:hover {
        background: #dc2626;
        transform: scale(1.1) rotate(90deg);
      }

      /* Text Area & Select */
      textarea {
        width: 100%;
        min-height: 300px;
        padding: 20px;
        border: 2px solid var(--border);
        border-radius: 12px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        resize: vertical;
        transition: all 0.3s;
      }

      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
      }

      select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Cpath fill='%236b7280' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 40px !important;
      }

      select:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      }

      select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
      }

      /* Buttons */
      button {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 16px 45px;
        border: none;
        border-radius: 12px;
        font-size: 1.05rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin-top: 20px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        letter-spacing: 0.3px;
      }

      button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
      }

      button:hover::before {
        width: 300px;
        height: 300px;
      }

      button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
      }

      button:active {
        transform: translateY(-1px);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #6b7280, #4b5563);
        box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
      }

      .btn-secondary:hover {
        box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
      }

      .btn-success {
        background: linear-gradient(135deg, var(--success), #059669);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      }

      .btn-success:hover {
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
      }

      /* Loading */
      .loading {
        display: none;
        text-align: center;
        padding: 50px;
      }

      .loading.active {
        display: block;
      }

      .spinner {
        border: 5px solid var(--border);
        border-top: 5px solid var(--primary);
        border-right: 5px solid var(--secondary);
        border-radius: 50%;
        width: 70px;
        height: 70px;
        animation: spin 1s ease-in-out infinite;
        margin: 0 auto 25px;
        position: relative;
      }

      .spinner::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 40px;
        height: 40px;
        border: 4px solid transparent;
        border-top: 4px solid var(--success);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: spin 0.8s linear infinite reverse;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading p {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--dark);
        animation: pulse 1.5s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }

      /* Results */
      .result-section {
        display: none;
        margin-top: 40px;
      }

      .result-section.active {
        display: block;
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border);
      }

      .action-buttons {
        display: flex;
        gap: 10px;
      }

      /* Alert */
      .alert {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: none;
      }

      .alert.show {
        display: block;
      }
      .alert-success {
        background: #d1fae5;
        color: #065f46;
        border-left: 4px solid var(--success);
      }
      .alert-error {
        background: #fee2e2;
        color: #991b1b;
        border-left: 4px solid var(--danger);
      }

      /* Info Grid */
      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin: 25px 0;
      }

      .info-item {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid var(--primary);
        transition: all 0.3s;
      }

      .info-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .info-item.highlight {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border-left-color: #f59e0b;
      }

      .info-item.seller-info {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        border-left-color: #3b82f6;
      }

      .info-item.buyer-info {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        border-left-color: #10b981;
      }

      .info-label {
        font-weight: 600;
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 8px;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .info-value input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 1rem;
        transition: all 0.3s;
      }

      .info-value input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
      }

      .info-value input.number-field {
        font-weight: 600;
        color: #059669;
        font-family: 'Courier New', monospace;
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 30px 0 15px;
        padding-bottom: 10px;
        border-bottom: 3px solid var(--primary);
      }

      .section-header h3 {
        color: #1f2937;
        font-size: 1.3rem;
        margin: 0;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        background: var(--primary);
        color: white;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .badge.seller {
        background: #3b82f6;
      }

      .badge.buyer {
        background: #10b981;
      }

      /* Table */
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 30px 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        overflow: hidden;
      }

      th {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 18px 15px;
        text-align: left;
        font-weight: 600;
      }

      td {
        padding: 15px;
        border-bottom: 1px solid var(--border);
      }

      tr:hover {
        background: rgba(102, 126, 234, 0.05);
      }

      table input {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
      }

      /* Summary */
      .summary-box {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-top: 30px;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        font-size: 1.1rem;
      }

      .summary-row:last-child {
        border-bottom: none;
        font-size: 1.4rem;
        font-weight: 700;
        padding-top: 20px;
        border-top: 2px solid rgba(255, 255, 255, 0.3);
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        h1 {
          font-size: 2rem;
        }
        .card {
          padding: 25px;
        }
        .info-grid {
          grid-template-columns: 1fr;
        }
        .result-header {
          flex-direction: column;
          gap: 15px;
        }
        .action-buttons {
          flex-direction: column;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üîç AMIS OCR System</h1>
        <p>Tr√≠ch xu·∫•t th√¥ng tin h√≥a ƒë∆°n t·ª± ƒë·ªông v·ªõi AI</p>
      </header>

      <div class="card">
        <div class="tabs">
          <button class="tab active" onclick="switchTab('upload')">
            üì§ Upload ·∫£nh
          </button>
          <button class="tab" onclick="switchTab('text')">‚å®Ô∏è Nh·∫≠p text</button>
        </div>

        <div id="alertBox"></div>

        <!-- Upload Tab -->
        <div id="uploadTab" class="tab-content active">
          <div
            class="upload-area"
            id="uploadArea"
            onclick="document.getElementById('fileInput').click()"
          >
            <div class="upload-icon">üìÅ</div>
            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px; color: #1f2937;">
              K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn
            </div>
            <div style="color: #6b7280; font-size: 0.95rem; margin-top: 10px">
              H·ªó tr·ª£: JPG, PNG, PDF ‚Ä¢ T·ªëi ƒëa 10MB
            </div>
            <input
              type="file"
              id="fileInput"
              accept=".jpg,.jpeg,.png,.pdf"
              onchange="handleFileSelect(event)"
            />
          </div>

          <!-- Image Preview -->
          <div id="imagePreview" class="image-preview">
            <div class="preview-container">
              <button class="remove-image" onclick="removeImage()" title="X√≥a ·∫£nh">‚úï</button>
              <img id="previewImg" src="" alt="Preview" />
            </div>
            <div class="preview-info">
              <span id="fileName"></span> ‚Ä¢ <span id="fileSize"></span>
            </div>
          </div>

          <div style="margin-top: 25px">
            <label style="font-weight: 600; margin-bottom: 10px; display: block; color: #1f2937; font-size: 1.05rem;"
              >Lo·∫°i ch·ª©ng t·ª´:</label
            >
            <select
              id="documentType"
              style="
                width: 100%;
                padding: 14px 16px;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s;
                background: white;
                color: #1f2937;
              "
            >
              <option value="auto">üîÆ T·ª± ƒë·ªông nh·∫≠n di·ªán</option>
              <option value="invoice">üìÑ H√≥a ƒë∆°n GTGT</option>
              <option value="receipt">üßæ Bi√™n lai</option>
            </select>
          </div>

          <button id="processBtn" onclick="processImage()" disabled>
            X·ª≠ l√Ω h√≥a ƒë∆°n
          </button>
        </div>

        <!-- Text Tab -->
        <div id="textTab" class="tab-content">
          <label style="font-weight: 600; margin-bottom: 10px; display: block; color: #1f2937; font-size: 1.05rem;"
            >N·ªôi dung h√≥a ƒë∆°n:</label
          >
          <textarea
            id="invoiceText"
            placeholder="Nh·∫≠p ho·∫∑c paste n·ªôi dung h√≥a ƒë∆°n...

V√≠ d·ª•:
C√îNG TY ABC
MST: 0123456789
H√≥a ƒë∆°n s·ªë: 001
Ng√†y: 27/01/2024
Kh√°ch h√†ng: C√¥ng ty XYZ
..."
          ></textarea>

          <div style="margin-top: 25px">
            <label style="font-weight: 600; margin-bottom: 10px; display: block; color: #1f2937; font-size: 1.05rem;"
              >Lo·∫°i ch·ª©ng t·ª´:</label
            >
            <select
              id="textDocumentType"
              style="
                width: 100%;
                padding: 14px 16px;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s;
                background: white;
                color: #1f2937;
              "
            >
              <option value="invoice">üìÑ H√≥a ƒë∆°n GTGT</option>
              <option value="receipt">üßæ Bi√™n lai</option>
            </select>
          </div>

          <button onclick="processText()">Ph√¢n t√≠ch h√≥a ƒë∆°n</button>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
          <div class="spinner"></div>
          <p>ƒêang x·ª≠ l√Ω... Vui l√≤ng ƒë·ª£i</p>
        </div>

        <!-- Results -->
        <div id="resultSection" class="result-section">
          <div class="result-header">
            <h2>üìã K·∫øt qu·∫£ tr√≠ch xu·∫•t</h2>
            <div class="action-buttons">
              <button class="btn-secondary" onclick="resetForm()">
                üîÑ L√†m m·ªõi
              </button>
              <button class="btn-success" onclick="exportToExcel()">
                üì• Export Excel
              </button>
            </div>
          </div>

          <div class="section-header">
            <h3>üìù Th√¥ng tin chung</h3>
          </div>
          <div class="info-grid" id="generalInfo"></div>

          <div class="section-header">
            <h3>üè¢ Th√¥ng tin ng∆∞·ªùi b√°n</h3>
            <span class="badge seller">SELLER</span>
          </div>
          <div class="info-grid" id="sellerInfo"></div>

          <div class="section-header">
            <h3>üõí Th√¥ng tin ng∆∞·ªùi mua</h3>
            <span class="badge buyer">BUYER</span>
          </div>
          <div class="info-grid" id="buyerInfo"></div>

          <div class="section-header">
            <h3>üì¶ Chi ti·∫øt h√†ng h√≥a</h3>
          </div>
          <table>
            <thead>
              <tr>
                <th>STT</th>
                <th>T√™n h√†ng</th>
                <th>ƒêVT</th>
                <th>SL</th>
                <th>ƒê∆°n gi√°</th>
                <th>Th√†nh ti·ªÅn</th>
                <th>Thu·∫ø</th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table>

          <div class="summary-box">
            <div class="summary-row">
              <span>T·ªïng ti·ªÅn h√†ng (ch∆∞a thu·∫ø):</span>
              <span id="totalWithoutVAT">0ƒë</span>
            </div>
            <div class="summary-row">
              <span>T·ªïng ti·ªÅn thu·∫ø VAT:</span>
              <span id="totalVAT">0ƒë</span>
            </div>
            <div class="summary-row">
              <span>T·ªîNG THANH TO√ÅN:</span>
              <span id="totalAmount">0ƒë</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:8000";
      let currentJobId = null;

      function formatMoney(val) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(val || 0);
      }

      function showAlert(msg, type) {
        const box = document.getElementById("alertBox");
        box.innerHTML = `<div class="alert alert-${type} show">${msg}</div>`;
        setTimeout(() => (box.innerHTML = ""), 5000);
      }

      function switchTab(tab) {
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));
        if (tab === "upload") {
          document.querySelector(".tab:first-child").classList.add("active");
          document.getElementById("uploadTab").classList.add("active");
        } else {
          document.querySelector(".tab:last-child").classList.add("active");
          document.getElementById("textTab").classList.add("active");
        }
      }

      const uploadArea = document.getElementById("uploadArea");
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });
      uploadArea.addEventListener("dragleave", () =>
        uploadArea.classList.remove("dragover"),
      );
      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length) {
          document.getElementById("fileInput").files = files;
          handleFileSelect({ target: { files } });
        }
      });

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
          showAlert("‚ùå File qu√° l·ªõn! Vui l√≤ng ch·ªçn file d∆∞·ªõi 10MB", "error");
          return;
        }

        // Show preview for images
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('imagePreview').classList.add('show');
            document.getElementById('uploadArea').style.display = 'none';
          };
          reader.readAsDataURL(file);
        }

        document.getElementById("processBtn").disabled = false;
        showAlert(`‚úÖ ƒê√£ ch·ªçn: ${file.name}`, "success");
      }

      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        else return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }

      function removeImage() {
        document.getElementById('fileInput').value = '';
        document.getElementById('imagePreview').classList.remove('show');
        document.getElementById('uploadArea').style.display = 'block';
        document.getElementById('processBtn').disabled = true;
        showAlert('üóëÔ∏è ƒê√£ x√≥a ·∫£nh', 'success');
      }

      async function processImage() {
        const file = document.getElementById("fileInput").files[0];
        if (!file) return showAlert("Ch·ªçn file!", "error");

        document.getElementById("loading").classList.add("active");
        const form = new FormData();
        form.append("file", file);
        form.append(
          "document_type",
          document.getElementById("documentType").value,
        );

        try {
          const res = await fetch(`${API_URL}/api/ocr/upload`, {
            method: "POST",
            body: form,
          });

          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }

          const data = await res.json();
          console.log('API Response:', data);
          document.getElementById("loading").classList.remove("active");

          if (data.success) {
            currentJobId = data.job_id;
            displayResults(data.data);
            showAlert("‚úÖ X·ª≠ l√Ω th√†nh c√¥ng!", "success");
          } else {
            console.error('API Error:', data);
            showAlert("‚ùå L·ªói: " + (data.error_message || "Unknown error"), "error");
          }
        } catch (err) {
          console.error('Request failed:', err);
          document.getElementById("loading").classList.remove("active");
          showAlert("‚ùå L·ªói: " + err.message, "error");
        }
      }

      async function processText() {
        const text = document.getElementById("invoiceText").value;
        if (!text.trim()) return showAlert("Nh·∫≠p text!", "error");

        document.getElementById("loading").classList.add("active");
        const form = new FormData();
        form.append("invoice_text", text);
        form.append(
          "document_type",
          document.getElementById("textDocumentType").value,
        );

        try {
          const res = await fetch(`${API_URL}/api/ocr/text`, {
            method: "POST",
            body: form,
          });

          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }

          const data = await res.json();
          console.log('API Response:', data);
          document.getElementById("loading").classList.remove("active");

          if (data.success) {
            currentJobId = data.job_id;
            displayResults(data.data);
            showAlert("‚úÖ Ph√¢n t√≠ch th√†nh c√¥ng!", "success");
          } else {
            console.error('API Error:', data);
            showAlert("‚ùå L·ªói: " + (data.error_message || "Unknown error"), "error");
          }
        } catch (err) {
          console.error('Request failed:', err);
          document.getElementById("loading").classList.remove("active");
          showAlert("‚ùå L·ªói: " + err.message, "error");
        }
      }

      function displayResults(data) {
        // Validate data structure
        if (!data || typeof data !== 'object') {
          console.error('Invalid data:', data);
          showAlert("‚ùå D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá", "error");
          return;
        }

        // Th√¥ng tin chung
        document.getElementById("generalInfo").innerHTML = `
                <div class="info-item highlight">
                    <div class="info-label">üìã K√Ω hi·ªáu Hƒê</div>
                    <div class="info-value"><input type="text" value="${data.inv_series ?? ""}"></div>
                </div>
                <div class="info-item highlight">
                    <div class="info-label">üìÖ Ng√†y Hƒê</div>
                    <div class="info-value"><input type="date" value="${data.inv_date ?? ""}"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">üí≥ H√¨nh th·ª©c TT</div>
                    <div class="info-value"><input type="text" value="${data.payment_method_name ?? "TM/CK"}"></div>
                </div>
            `;

        // Th√¥ng tin ng∆∞·ªùi b√°n
        document.getElementById("sellerInfo").innerHTML = `
                <div class="info-item seller-info">
                    <div class="info-label">üè¢ T√™n c√¥ng ty b√°n</div>
                    <div class="info-value"><input type="text" value="${data.seller_legal_name ?? ""}"></div>
                </div>
                <div class="info-item seller-info highlight">
                    <div class="info-label">üî¢ MST ng∆∞·ªùi b√°n</div>
                    <div class="info-value"><input type="text" class="number-field" value="${data.seller_tax_code ?? ""}"></div>
                </div>
                <div class="info-item seller-info">
                    <div class="info-label">üìç ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n</div>
                    <div class="info-value"><input type="text" value="${data.seller_address ?? ""}"></div>
                </div>
            `;

        // Th√¥ng tin ng∆∞·ªùi mua
        document.getElementById("buyerInfo").innerHTML = `
                <div class="info-item buyer-info">
                    <div class="info-label">üè™ T√™n ng∆∞·ªùi mua</div>
                    <div class="info-value"><input type="text" value="${data.buyer_legal_name ?? ""}"></div>
                </div>
                <div class="info-item buyer-info highlight">
                    <div class="info-label">üî¢ MST ng∆∞·ªùi mua</div>
                    <div class="info-value"><input type="text" class="number-field" value="${data.buyer_tax_code ?? ""}"></div>
                </div>
                <div class="info-item buyer-info">
                    <div class="info-label">üìç ƒê·ªãa ch·ªâ ng∆∞·ªùi mua</div>
                    <div class="info-value"><input type="text" value="${data.buyer_address ?? ""}"></div>
                </div>
                <div class="info-item buyer-info">
                    <div class="info-label">üìû S·ªë ƒëi·ªán tho·∫°i</div>
                    <div class="info-value"><input type="text" value="${data.buyer_phone_number ?? ""}"></div>
                </div>
                <div class="info-item buyer-info">
                    <div class="info-label">‚úâÔ∏è Email</div>
                    <div class="info-value"><input type="email" value="${data.buyer_email ?? ""}"></div>
                </div>
            `;

        // Hi·ªÉn th·ªã items
        const tbody = document.getElementById("itemsBody");
        tbody.innerHTML = "";
        const items = data.original_invoice_detail || [];
        items.forEach((item, i) => {
          tbody.innerHTML += `
                    <tr>
                        <td style="text-align:center; font-weight:600; background: #f3f4f6;">${i + 1}</td>
                        <td><input type="text" value="${item.item_name ?? ""}"></td>
                        <td><input type="text" value="${item.unit_name ?? ""}" style="width:80px;"></td>
                        <td><input type="number" class="number-field" value="${item.quantity ?? 0}" style="width:80px;"></td>
                        <td style="text-align:right; color: #059669; font-weight: 600; font-family: 'Courier New', monospace;">${formatMoney(item.unit_price ?? 0)}</td>
                        <td style="text-align:right; font-weight:700; color: #047857; font-size: 1.05rem; background: #ecfdf5;">${formatMoney(item.amount_without_vat ?? 0)}</td>
                        <td><input type="text" value="${item.vat_rate_name ?? ""}" style="width:70px;"></td>
                    </tr>
                `;
        });

        document.getElementById("totalWithoutVAT").textContent = formatMoney(
          data.total_amount_without_vat,
        );
        document.getElementById("totalVAT").textContent = formatMoney(
          data.total_vat_amount,
        );
        document.getElementById("totalAmount").textContent = formatMoney(
          data.total_amount,
        );

        document.getElementById("resultSection").classList.add("active");
        document
          .getElementById("resultSection")
          .scrollIntoView({ behavior: "smooth" });
      }

      async function exportToExcel() {
        if (!currentJobId) return showAlert("Ch∆∞a c√≥ d·ªØ li·ªáu!", "error");

        const res = await fetch(`${API_URL}/api/export/amis/${currentJobId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            job_id: currentJobId,
            export_format: "excel",
            template_type: "general",
          }),
        });
        const data = await res.json();
        if (data.success) {
          window.open(`${API_URL}${data.download_url}`);
          showAlert("‚úÖ ƒêang t·∫£i file...", "success");
        }
      }

      function resetForm() {
        document.getElementById("fileInput").value = "";
        document.getElementById("invoiceText").value = "";
        document.getElementById("processBtn").disabled = true;
        document.getElementById("resultSection").classList.remove("active");
        document.getElementById('imagePreview').classList.remove('show');
        document.getElementById('uploadArea').style.display = 'block';
        currentJobId = null;
        showAlert("‚ú® ƒê√£ l√†m m·ªõi", "success");
      }
    </script>
  </body>
</html>
